<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitLog - Gym Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .app-header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .app-header h1 {
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .app-header .subtitle {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
        }

        @media (max-width: 968px) {
            .main-container {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            padding: 25px;
        }

        .card-header {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }

        .tab-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
            margin: 0;
            border-radius: 0;
        }

        .tab:hover {
            color: #667eea;
            transform: none;
            box-shadow: none;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
            font-size: 0.9em;
        }

        input, textarea, select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
            font-family: inherit;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        select {
            cursor: pointer;
        }

        .input-group {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.9em;
        }

        .btn-full {
            width: 100%;
        }

        .message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            display: none;
            animation: slideIn 0.3s ease-out;
        }

        .message.show {
            display: block;
        }

        .message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .exercise-list {
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px;
        }

        .exercise-item {
            padding: 12px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .exercise-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .exercise-item .exercise-name {
            font-weight: 600;
            color: #333;
        }

        .exercise-item .exercise-category {
            font-size: 0.85em;
            color: #666;
            display: block;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-chest { background: #e3f2fd; color: #1976d2; }
        .badge-back { background: #f3e5f5; color: #7b1fa2; }
        .badge-legs { background: #e8f5e9; color: #388e3c; }
        .badge-shoulders { background: #fff3e0; color: #f57c00; }
        .badge-arms { background: #fce4ec; color: #c2185b; }
        .badge-core { background: #fff9c4; color: #f57f17; }
        .badge-cardio { background: #ffebee; color: #c62828; }
        .badge-full-body { background: #e0f2f1; color: #00796b; }

        .workout-session {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .workout-session-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .exercise-entry {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
        }

        .exercise-entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .exercise-entry-name {
            font-weight: 600;
            color: #333;
            font-size: 1.1em;
        }

        .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 0.85em;
            cursor: pointer;
        }

        .template-item {
            padding: 15px;
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .template-item:hover {
            border-color: #667eea;
            background: #e9ecef;
            transform: translateX(5px);
        }

        .template-item .template-name {
            font-weight: 600;
            color: #333;
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .template-item .template-exercises {
            font-size: 0.9em;
            color: #666;
        }

        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .required {
            color: #e74c3c;
        }

        .search-box {
            position: relative;
            margin-bottom: 15px;
        }

        .filter-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .filter-pill {
            padding: 6px 12px;
            background: #e9ecef;
            border: 2px solid #e9ecef;
            border-radius: 20px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-pill:hover {
            background: #dee2e6;
        }

        .filter-pill.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="app-header">
        <h1>FitLog</h1>
        <p class="subtitle">Track your gym progress with workout templates and exercise library</p>
    </div>

    <div class="main-container">
        <!-- Left Sidebar: Exercise Library & Templates -->
        <div>
            <div class="card">
                <div class="tab-container">
                    <button class="tab active" onclick="switchSidebarTab('exercises')">Exercise Library</button>
                    <button class="tab" onclick="switchSidebarTab('templates')">Templates</button>
                </div>

                <!-- Exercise Library Tab -->
                <div id="exercises-tab" class="tab-content active">
                    <div class="search-box">
                        <input type="text" id="exerciseSearch" placeholder="Search exercises..." oninput="filterExercises()">
                    </div>

                    <div class="filter-pills" id="categoryFilters"></div>

                    <div class="exercise-list" id="exerciseList"></div>
                </div>

                <!-- Templates Tab -->
                <div id="templates-tab" class="tab-content">
                    <div class="form-group">
                        <button class="btn-success btn-full" onclick="saveCurrentWorkoutAsTemplate()">
                            Save Current Workout as Template
                        </button>
                    </div>

                    <h3 style="margin-bottom: 10px; color: #555;">Pre-made Templates</h3>
                    <div id="premadeTemplatesList"></div>

                    <h3 style="margin: 20px 0 10px; color: #555;">My Custom Templates</h3>
                    <div id="customTemplatesList"></div>
                </div>
            </div>
        </div>

        <!-- Right Panel: Workout Form -->
        <div>
            <div class="card">
                <h2 class="card-header">Log Workout</h2>

                <form id="workoutForm">
                    <div class="form-group">
                        <label for="userId">User ID <span class="required">*</span></label>
                        <input type="text" id="userId" placeholder="e.g., john_doe" required>
                    </div>

                    <div id="exercisesContainer"></div>

                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button type="button" class="btn-secondary" onclick="addExerciseEntry()" style="flex: 1;">
                            + Add Exercise
                        </button>
                        <button type="submit" id="submitBtn" class="btn-success" style="flex: 2;">
                            Log Workout
                        </button>
                    </div>
                </form>

                <div id="message" class="message"></div>
            </div>
        </div>
    </div>

    <script>
        const API_ENDPOINT = 'https://axny6wupg53gpasqhoz37a5f3u0izcwt.lambda-url.us-east-1.on.aws/';

        // Comprehensive Exercise Database
        const EXERCISE_DATABASE = [
            // Chest
            { name: "Barbell Bench Press", category: "Chest", type: "Push", equipment: "Barbell" },
            { name: "Incline Barbell Bench Press", category: "Chest", type: "Push", equipment: "Barbell" },
            { name: "Decline Barbell Bench Press", category: "Chest", type: "Push", equipment: "Barbell" },
            { name: "Dumbbell Bench Press", category: "Chest", type: "Push", equipment: "Dumbbell" },
            { name: "Incline Dumbbell Press", category: "Chest", type: "Push", equipment: "Dumbbell" },
            { name: "Dumbbell Flyes", category: "Chest", type: "Push", equipment: "Dumbbell" },
            { name: "Cable Flyes", category: "Chest", type: "Push", equipment: "Cable" },
            { name: "Chest Dips", category: "Chest", type: "Push", equipment: "Bodyweight" },
            { name: "Push-ups", category: "Chest", type: "Push", equipment: "Bodyweight" },
            { name: "Machine Chest Press", category: "Chest", type: "Push", equipment: "Machine" },

            // Back
            { name: "Deadlift", category: "Back", type: "Pull", equipment: "Barbell" },
            { name: "Barbell Row", category: "Back", type: "Pull", equipment: "Barbell" },
            { name: "Pull-ups", category: "Back", type: "Pull", equipment: "Bodyweight" },
            { name: "Chin-ups", category: "Back", type: "Pull", equipment: "Bodyweight" },
            { name: "Lat Pulldown", category: "Back", type: "Pull", equipment: "Cable" },
            { name: "Seated Cable Row", category: "Back", type: "Pull", equipment: "Cable" },
            { name: "T-Bar Row", category: "Back", type: "Pull", equipment: "Machine" },
            { name: "Dumbbell Row", category: "Back", type: "Pull", equipment: "Dumbbell" },
            { name: "Face Pulls", category: "Back", type: "Pull", equipment: "Cable" },
            { name: "Hyperextensions", category: "Back", type: "Pull", equipment: "Bodyweight" },

            // Legs
            { name: "Barbell Squat", category: "Legs", type: "Legs", equipment: "Barbell" },
            { name: "Front Squat", category: "Legs", type: "Legs", equipment: "Barbell" },
            { name: "Romanian Deadlift", category: "Legs", type: "Legs", equipment: "Barbell" },
            { name: "Leg Press", category: "Legs", type: "Legs", equipment: "Machine" },
            { name: "Leg Curl", category: "Legs", type: "Legs", equipment: "Machine" },
            { name: "Leg Extension", category: "Legs", type: "Legs", equipment: "Machine" },
            { name: "Lunges", category: "Legs", type: "Legs", equipment: "Bodyweight" },
            { name: "Bulgarian Split Squat", category: "Legs", type: "Legs", equipment: "Dumbbell" },
            { name: "Calf Raises", category: "Legs", type: "Legs", equipment: "Machine" },
            { name: "Hip Thrust", category: "Legs", type: "Legs", equipment: "Barbell" },

            // Shoulders
            { name: "Overhead Press", category: "Shoulders", type: "Push", equipment: "Barbell" },
            { name: "Dumbbell Shoulder Press", category: "Shoulders", type: "Push", equipment: "Dumbbell" },
            { name: "Lateral Raises", category: "Shoulders", type: "Push", equipment: "Dumbbell" },
            { name: "Front Raises", category: "Shoulders", type: "Push", equipment: "Dumbbell" },
            { name: "Rear Delt Flyes", category: "Shoulders", type: "Push", equipment: "Dumbbell" },
            { name: "Arnold Press", category: "Shoulders", type: "Push", equipment: "Dumbbell" },
            { name: "Upright Row", category: "Shoulders", type: "Push", equipment: "Barbell" },
            { name: "Shrugs", category: "Shoulders", type: "Push", equipment: "Barbell" },

            // Arms
            { name: "Barbell Curl", category: "Arms", type: "Pull", equipment: "Barbell" },
            { name: "Dumbbell Curl", category: "Arms", type: "Pull", equipment: "Dumbbell" },
            { name: "Hammer Curl", category: "Arms", type: "Pull", equipment: "Dumbbell" },
            { name: "Preacher Curl", category: "Arms", type: "Pull", equipment: "Machine" },
            { name: "Cable Curl", category: "Arms", type: "Pull", equipment: "Cable" },
            { name: "Tricep Dips", category: "Arms", type: "Push", equipment: "Bodyweight" },
            { name: "Tricep Pushdown", category: "Arms", type: "Push", equipment: "Cable" },
            { name: "Overhead Tricep Extension", category: "Arms", type: "Push", equipment: "Dumbbell" },
            { name: "Skull Crushers", category: "Arms", type: "Push", equipment: "Barbell" },
            { name: "Close-Grip Bench Press", category: "Arms", type: "Push", equipment: "Barbell" },

            // Core
            { name: "Plank", category: "Core", type: "Core", equipment: "Bodyweight" },
            { name: "Crunches", category: "Core", type: "Core", equipment: "Bodyweight" },
            { name: "Russian Twists", category: "Core", type: "Core", equipment: "Bodyweight" },
            { name: "Leg Raises", category: "Core", type: "Core", equipment: "Bodyweight" },
            { name: "Cable Crunches", category: "Core", type: "Core", equipment: "Cable" },
            { name: "Ab Wheel Rollout", category: "Core", type: "Core", equipment: "Equipment" },
            { name: "Hanging Knee Raises", category: "Core", type: "Core", equipment: "Bodyweight" },
        ];

        // Pre-made Workout Templates
        const PREMADE_TEMPLATES = [
            {
                name: "Push Day",
                exercises: [
                    { exercise: "Barbell Bench Press", sets: 4, reps: 8 },
                    { exercise: "Incline Dumbbell Press", sets: 3, reps: 10 },
                    { exercise: "Dumbbell Flyes", sets: 3, reps: 12 },
                    { exercise: "Overhead Press", sets: 4, reps: 8 },
                    { exercise: "Lateral Raises", sets: 3, reps: 12 },
                    { exercise: "Tricep Pushdown", sets: 3, reps: 12 }
                ]
            },
            {
                name: "Pull Day",
                exercises: [
                    { exercise: "Deadlift", sets: 4, reps: 6 },
                    { exercise: "Pull-ups", sets: 3, reps: 10 },
                    { exercise: "Barbell Row", sets: 4, reps: 8 },
                    { exercise: "Lat Pulldown", sets: 3, reps: 10 },
                    { exercise: "Face Pulls", sets: 3, reps: 15 },
                    { exercise: "Barbell Curl", sets: 3, reps: 10 }
                ]
            },
            {
                name: "Leg Day",
                exercises: [
                    { exercise: "Barbell Squat", sets: 4, reps: 8 },
                    { exercise: "Romanian Deadlift", sets: 3, reps: 10 },
                    { exercise: "Leg Press", sets: 3, reps: 12 },
                    { exercise: "Leg Curl", sets: 3, reps: 12 },
                    { exercise: "Leg Extension", sets: 3, reps: 12 },
                    { exercise: "Calf Raises", sets: 4, reps: 15 }
                ]
            },
            {
                name: "Upper Body",
                exercises: [
                    { exercise: "Barbell Bench Press", sets: 4, reps: 8 },
                    { exercise: "Barbell Row", sets: 4, reps: 8 },
                    { exercise: "Overhead Press", sets: 3, reps: 10 },
                    { exercise: "Pull-ups", sets: 3, reps: 10 },
                    { exercise: "Dumbbell Curl", sets: 3, reps: 12 },
                    { exercise: "Tricep Dips", sets: 3, reps: 12 }
                ]
            },
            {
                name: "Full Body Strength",
                exercises: [
                    { exercise: "Barbell Squat", sets: 4, reps: 6 },
                    { exercise: "Barbell Bench Press", sets: 4, reps: 6 },
                    { exercise: "Deadlift", sets: 3, reps: 6 },
                    { exercise: "Overhead Press", sets: 3, reps: 8 },
                    { exercise: "Pull-ups", sets: 3, reps: 8 }
                ]
            },
            {
                name: "Arm Focus",
                exercises: [
                    { exercise: "Barbell Curl", sets: 4, reps: 10 },
                    { exercise: "Tricep Pushdown", sets: 4, reps: 10 },
                    { exercise: "Hammer Curl", sets: 3, reps: 12 },
                    { exercise: "Overhead Tricep Extension", sets: 3, reps: 12 },
                    { exercise: "Preacher Curl", sets: 3, reps: 12 },
                    { exercise: "Close-Grip Bench Press", sets: 3, reps: 10 }
                ]
            }
        ];

        let currentFilter = 'All';
        let currentExercises = [];

        // Initialize
        window.addEventListener('load', () => {
            initializeExerciseLibrary();
            initializeTemplates();
            addExerciseEntry();

            const savedUserId = localStorage.getItem('fitlog_userId');
            if (savedUserId) {
                document.getElementById('userId').value = savedUserId;
            }
        });

        function initializeExerciseLibrary() {
            renderCategoryFilters();
            renderExerciseList();
        }

        function renderCategoryFilters() {
            const categories = ['All', ...new Set(EXERCISE_DATABASE.map(ex => ex.category))];
            const filtersHtml = categories.map(cat =>
                `<div class="filter-pill ${cat === currentFilter ? 'active' : ''}" onclick="setFilter('${cat}')">${cat}</div>`
            ).join('');
            document.getElementById('categoryFilters').innerHTML = filtersHtml;
        }

        function setFilter(category) {
            currentFilter = category;
            renderCategoryFilters();
            filterExercises();
        }

        function filterExercises() {
            const searchTerm = document.getElementById('exerciseSearch').value.toLowerCase();
            const filtered = EXERCISE_DATABASE.filter(ex => {
                const matchesCategory = currentFilter === 'All' || ex.category === currentFilter;
                const matchesSearch = ex.name.toLowerCase().includes(searchTerm);
                return matchesCategory && matchesSearch;
            });
            renderExerciseList(filtered);
        }

        function renderExerciseList(exercises = EXERCISE_DATABASE) {
            const listHtml = exercises.map(ex => `
                <div class="exercise-item" onclick="selectExercise('${ex.name}')">
                    <div>
                        <div class="exercise-name">${ex.name}</div>
                        <span class="exercise-category">${ex.equipment}</span>
                    </div>
                    <span class="badge badge-${ex.category.toLowerCase()}">${ex.category}</span>
                </div>
            `).join('');

            document.getElementById('exerciseList').innerHTML = listHtml ||
                '<div class="empty-state"><div class="empty-state-icon">üîç</div><div>No exercises found</div></div>';
        }

        function selectExercise(exerciseName) {
            const entries = document.querySelectorAll('.exercise-entry');
            const lastEntry = entries[entries.length - 1];

            if (lastEntry) {
                const select = lastEntry.querySelector('select');
                if (select) {
                    select.value = exerciseName;
                }
            } else {
                addExerciseEntry(exerciseName);
            }
        }

        function addExerciseEntry(exerciseName = '') {
            const container = document.getElementById('exercisesContainer');
            const entryId = Date.now();

            const exerciseOptions = EXERCISE_DATABASE.map(ex =>
                `<option value="${ex.name}" ${ex.name === exerciseName ? 'selected' : ''}>${ex.name}</option>`
            ).join('');

            const entryHtml = `
                <div class="exercise-entry" data-entry-id="${entryId}">
                    <div class="exercise-entry-header">
                        <span class="exercise-entry-name">Exercise ${container.children.length + 1}</span>
                        <button type="button" class="remove-btn" onclick="removeExerciseEntry(${entryId})">Remove</button>
                    </div>

                    <div class="form-group">
                        <label>Exercise <span class="required">*</span></label>
                        <select required>
                            <option value="">Select an exercise...</option>
                            ${exerciseOptions}
                        </select>
                    </div>

                    <div class="input-group">
                        <div class="form-group">
                            <label>Sets</label>
                            <input type="number" placeholder="3" min="1" class="sets-input">
                        </div>
                        <div class="form-group">
                            <label>Reps</label>
                            <input type="number" placeholder="10" min="1" class="reps-input">
                        </div>
                        <div class="form-group">
                            <label>Weight (lbs)</label>
                            <input type="number" placeholder="135" min="0" step="0.5" class="weight-input">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Notes (Optional)</label>
                        <textarea placeholder="How did it feel?" class="notes-input"></textarea>
                    </div>
                </div>
            `;

            container.insertAdjacentHTML('beforeend', entryHtml);
        }

        function removeExerciseEntry(entryId) {
            const entry = document.querySelector(`[data-entry-id="${entryId}"]`);
            if (entry) {
                entry.remove();
            }

            // Renumber remaining entries
            const entries = document.querySelectorAll('.exercise-entry');
            entries.forEach((entry, idx) => {
                entry.querySelector('.exercise-entry-name').textContent = `Exercise ${idx + 1}`;
            });

            // Add one back if empty
            if (entries.length === 0) {
                addExerciseEntry();
            }
        }

        function initializeTemplates() {
            renderPremadeTemplates();
            renderCustomTemplates();
        }

        function renderPremadeTemplates() {
            const html = PREMADE_TEMPLATES.map((template, idx) => `
                <div class="template-item" onclick="loadTemplate(${idx}, true)">
                    <div class="template-name">${template.name}</div>
                    <div class="template-exercises">${template.exercises.length} exercises</div>
                </div>
            `).join('');
            document.getElementById('premadeTemplatesList').innerHTML = html;
        }

        function renderCustomTemplates() {
            const customTemplates = JSON.parse(localStorage.getItem('fitlog_custom_templates') || '[]');

            if (customTemplates.length === 0) {
                document.getElementById('customTemplatesList').innerHTML =
                    '<div class="empty-state"><div class="empty-state-icon">üìã</div><div>No custom templates yet</div></div>';
                return;
            }

            const html = customTemplates.map((template, idx) => `
                <div class="template-item">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div onclick="loadTemplate(${idx}, false)" style="flex: 1;">
                            <div class="template-name">${template.name}</div>
                            <div class="template-exercises">${template.exercises.length} exercises</div>
                        </div>
                        <button class="btn-danger btn-small" onclick="event.stopPropagation(); deleteCustomTemplate(${idx})">Delete</button>
                    </div>
                </div>
            `).join('');
            document.getElementById('customTemplatesList').innerHTML = html;
        }

        function loadTemplate(index, isPremade) {
            const template = isPremade ? PREMADE_TEMPLATES[index] :
                JSON.parse(localStorage.getItem('fitlog_custom_templates'))[index];

            // Clear existing entries
            document.getElementById('exercisesContainer').innerHTML = '';

            // Add exercises from template
            template.exercises.forEach(ex => {
                addExerciseEntry(ex.exercise);
                const entries = document.querySelectorAll('.exercise-entry');
                const lastEntry = entries[entries.length - 1];

                if (ex.sets) lastEntry.querySelector('.sets-input').value = ex.sets;
                if (ex.reps) lastEntry.querySelector('.reps-input').value = ex.reps;
                if (ex.weight) lastEntry.querySelector('.weight-input').value = ex.weight;
                if (ex.notes) lastEntry.querySelector('.notes-input').value = ex.notes;
            });

            showMessage('success', `Template "${template.name}" loaded successfully!`);
            switchSidebarTab('exercises');
        }

        function saveCurrentWorkoutAsTemplate() {
            const entries = document.querySelectorAll('.exercise-entry');

            if (entries.length === 0) {
                showMessage('error', 'Add at least one exercise before saving a template!');
                return;
            }

            const name = prompt('Enter template name:');
            if (!name) return;

            const exercises = Array.from(entries).map(entry => ({
                exercise: entry.querySelector('select').value,
                sets: parseInt(entry.querySelector('.sets-input').value) || null,
                reps: parseInt(entry.querySelector('.reps-input').value) || null,
                weight: parseFloat(entry.querySelector('.weight-input').value) || null,
                notes: entry.querySelector('.notes-input').value || ''
            })).filter(ex => ex.exercise);

            if (exercises.length === 0) {
                showMessage('error', 'Select at least one exercise!');
                return;
            }

            const customTemplates = JSON.parse(localStorage.getItem('fitlog_custom_templates') || '[]');
            customTemplates.push({ name, exercises });
            localStorage.setItem('fitlog_custom_templates', JSON.stringify(customTemplates));

            renderCustomTemplates();
            showMessage('success', `Template "${name}" saved successfully!`);
        }

        function deleteCustomTemplate(index) {
            if (!confirm('Are you sure you want to delete this template?')) return;

            const customTemplates = JSON.parse(localStorage.getItem('fitlog_custom_templates') || '[]');
            customTemplates.splice(index, 1);
            localStorage.setItem('fitlog_custom_templates', JSON.stringify(customTemplates));

            renderCustomTemplates();
            showMessage('success', 'Template deleted successfully!');
        }

        function switchSidebarTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(`${tab}-tab`).classList.add('active');
        }

        // Form submission
        document.getElementById('workoutForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const submitBtn = document.getElementById('submitBtn');
            const userId = document.getElementById('userId').value.trim();
            const entries = document.querySelectorAll('.exercise-entry');

            if (entries.length === 0) {
                showMessage('error', 'Add at least one exercise!');
                return;
            }

            const exercises = Array.from(entries).map(entry => ({
                exercise: entry.querySelector('select').value,
                sets: parseInt(entry.querySelector('.sets-input').value) || null,
                reps: parseInt(entry.querySelector('.reps-input').value) || null,
                weight: parseFloat(entry.querySelector('.weight-input').value) || null,
                notes: entry.querySelector('.notes-input').value || ''
            })).filter(ex => ex.exercise);

            if (exercises.length === 0) {
                showMessage('error', 'Please select at least one exercise!');
                return;
            }

            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="loader"></span>Logging workout...';

            try {
                // Log each exercise separately
                for (const exercise of exercises) {
                    const workout = { userId, ...exercise };

                    const response = await fetch(API_ENDPOINT, {
                        method: 'POST',
                        mode: 'cors',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify(workout)
                    });

                    if (!response.ok) {
                        const data = await response.json();
                        throw new Error(data.error || 'Failed to log workout');
                    }
                }

                showMessage('success', `Successfully logged ${exercises.length} exercise(s)! Check your email for confirmation.`);

                // Save user ID and reset form
                localStorage.setItem('fitlog_userId', userId);
                document.getElementById('exercisesContainer').innerHTML = '';
                addExerciseEntry();

            } catch (error) {
                console.error('Error:', error);
                showMessage('error', `Error: ${error.message}`);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Log Workout';
            }
        });

        function showMessage(type, content) {
            const messageDiv = document.getElementById('message');
            messageDiv.className = `message ${type} show`;
            messageDiv.innerHTML = content;
            setTimeout(() => messageDiv.classList.remove('show'), 5000);
        }
    </script>
</body>
</html>
